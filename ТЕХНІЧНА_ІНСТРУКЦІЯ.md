# Технічна інструкція: Turntable P3032

## 1. РОЗПІНОВКА (PINOUT)

### Цифрові піни

| Пін | Напрямок | Пристрій | Примітки |
|-----|----------|----------|----------|
| 2 | INPUT | ENC_A (інкрементальний енкодер) | INT0, для навігації по меню |
| 3 | INPUT | ENC_B (інкрементальний енкодер) | INT1, для навігації по меню |
| 4 | INPUT_PULLUP | ENC_BTN (кнопка енкодера) | Активний LOW, коротке натискання = вибір, довге (≥2 сек) = повернення на сплеш-екран |
| 5 | INPUT_PULLUP | ENCODER_ZERO_BUTTON (кнопка обнулення енкодера) | Активний LOW, встановлює поточний кут як 0° |
| 6 | OUTPUT | STEP_PIN (кроковий двигун) | Імпульси для руху двигуна |
| 7 | OUTPUT | DIR_PIN (напрямок крокового двигуна) | LOW/HIGH для зміни напрямку |
| 8 | INPUT_PULLUP | DIGIT_MODE_BUTTON (кнопка перемикання розрядів) | Активний LOW, тільки в меню Set Angle |
| 9 | OUTPUT | ENABLE_PIN (утримання крокового двигуна) | LOW = утримується, HIGH = знято з утримання |
| 11 | OUTPUT | START_STOP_LED (світлодіод старт-стоп) | Тільки для Nano/Uno |
| 12 | INPUT_PULLUP | START_STOP_BUTTON (кнопка старт-стоп) | Активний LOW, тільки для Nano/Uno |

### Аналогові піни

| Пін | Напрямок | Пристрій | Примітки |
|-----|----------|----------|----------|
| A0 | INPUT (analog) | ABS_ENC_PIN (абсолютний енкодер P3022-CW360) | Діапазон 0-5V відповідає 0-360° |
| A2 | INPUT_PULLUP | STEP_FINE_ADJUST_BUTTON (кнопка точного регулювання) | Активний LOW, рух на 1 крок вперед |

### I2C піни (для LCD2004 I2C)

| Пін | Напрямок | Пристрій | Примітки |
|-----|----------|----------|----------|
| A4 (Nano/Uno) / 20 (Mega) | INPUT/OUTPUT | SDA (I2C Data) | Для LCD2004 I2C модуля |
| A5 (Nano/Uno) / 21 (Mega) | INPUT/OUTPUT | SCL (I2C Clock) | Для LCD2004 I2C модуля |

**Примітка:** Адреса I2C LCD: 0x27 (може бути 0x3F залежно від модуля)

### Піни для 4-bit LCD (не використовуються в поточній конфігурації)

| Пін | Напрямок | Пристрій | Примітки |
|-----|----------|----------|----------|
| 8 | - | LCD_RS | Не використовується (LCD_MODE = 1) |
| 9 | - | LCD_E | Не використовується (LCD_MODE = 1) |
| 10-13 | - | LCD_D4-D7 | Не використовуються (LCD_MODE = 1) |

---

## 2. ПОРЯДОК ВИКОРИСТАННЯ

### 2.1. Поведінка при включенні

1. **Ініціалізація:**
   - Завантаження налаштувань з EEPROM (позиція, напрямок, нуль двигуна)
   - Встановлення початкової позиції двигуна
   - Встановлення напрямку руху (CW/CCW)
   - Встановлення нульової позиції двигуна
   - Читання початкового кута з абсолютного енкодера

2. **Початковий екран (Splash Screen):**
   - Рядок 0: "Motor:Hold ON" або "Motor:Released" (стан утримання двигуна)
   - Рядок 1: "Encoder: XXX.XX°" (кут з абсолютного енкодера, 2 знаки після коми)
   - Рядок 2: "Target: XXX°" (цільовий кут)
   - Рядок 3: "Menu:Ok Btn:Start" (коли зупинений) або "Status: RUNNING" (коли рухається)

### 2.2. Навігація по меню

#### Перехід в головне меню

- **Коротке натискання** кнопки енкодера (ENC_BTN) на сплеш-екрані → перехід в головне меню

#### Головне меню (Main Menu)

**Відображення:**
- Рядок 0: "Main Menu"
- Рядок 1: "> Set Angle" (вибраний пункт)
- Рядок 2: "  Settings"
- Рядок 3: "  Save Position"

**Навігація:**
- **Обертання інкрементального енкодера** (ENC_A/ENC_B):
  - За годинниковою стрілкою → перехід до наступного пункту
  - Проти годинникової стрілки → перехід до попереднього пункту
  - Затримка між змінами: 150 мс (MENU_CHANGE_DELAY_MS)
  - Обгортка: з останнього пункту перехід на перший і навпаки

- **Коротке натискання** кнопки енкодера → вхід у вибраний пункт меню

- **Довге натискання** кнопки енкодера (≥2 секунди) → повернення на сплеш-екран

#### Меню "Set Angle" (Встановлення кута)

**Відображення:**
- Рядок 0: "Target: XXX°" (цільовий кут)
- Рядок 1: "Mode: Units" / "Mode: Tens" / "Mode: Hundreds" (режим редагування розряду)
- Рядок 2: (порожній)
- Рядок 3: "Btn:Ok"

**Редагування кута:**
- **Обертання інкрементального енкодера:**
  - Режим "Units": ±1 градус за оберт
  - Режим "Tens": ±10 градусів за оберт
  - Режим "Hundreds": ±100 градусів за оберт
  - Затримка між змінами: 150 мс

- **Перемикання режиму розряду:**
  - Натискання кнопки DIGIT_MODE_BUTTON (пін 8) → циклічне перемикання: Units → Tens → Hundreds → Units

- **Обмеження кута:**
  - Діапазон: 0-359 градусів
  - При перевищенні 359 → встановлюється 0
  - При меншому за 0 → встановлюється 359

- **Вихід з меню:**
  - Коротке натискання кнопки енкодера → повернення на сплеш-екран
  - Довге натискання (≥2 секунди) → повернення на сплеш-екран

#### Меню "Settings" (Налаштування)

**Відображення:**
- Рядок 0: (порожній)
- Рядок 1: "> CW  (Clockwise)" або "> CCW (Counter-CW)" (вибраний напрямок)
- Рядок 2: (порожній)
- Рядок 3: "Btn:Ok"

**Зміна напрямку:**
- **Обертання інкрементального енкодера:**
  - Будь-яке обертання → перемикання між CW та CCW
  - Затримка між змінами: 150 мс

- **Вихід з меню:**
  - Коротке натискання кнопки енкодера → повернення на сплеш-екран
  - Напрямок автоматично зберігається в EEPROM при збереженні позиції

#### Меню "Save" (Збереження)

**Відображення:**
- Рядок 0: (порожній)
- Рядок 1: "Save Position"
- Рядок 2: (порожній)
- Рядок 3: "Btn:Ok"

**Збереження:**
- **Коротке натискання** кнопки енкодера → збереження поточної позиції, напрямку та нуля двигуна в EEPROM
- Після збереження → автоматичне повернення на сплеш-екран
- Показується повідомлення "Encoder" на 400 мс

### 2.3. Поведінка енкодерів

#### Інкрементальний енкодер (ENC_A/ENC_B)

**Призначення:** Навігація по меню та редагування кута

**Поведінка:**
- Обертання за годинниковою стрілкою → збільшення значення / перехід до наступного пункту
- Обертання проти годинникової стрілки → зменшення значення / перехід до попереднього пункту
- Обмеження: тільки ±1 крок за раз (для плавної навігації)
- Затримка між обробкою подій: 150 мс

**Використання:**
- На сплеш-екрані: не використовується
- В головному меню: навігація по пунктах
- В меню Set Angle: редагування кута (крок залежить від режиму розряду)
- В меню Settings: перемикання напрямку (CW ↔ CCW)

#### Абсолютний енкодер P3022-CW360 (A0)

**Призначення:** Встановлення цільового кута

**Поведінка:**
- Постійне читання кута (0-360°)
- Автоматичне встановлення як цільовий кут
- Фільтрація: ковзне середнє з 8 зразків
- Оновлення: кожні 10 мс

**Обмеження:**
- Не оновлює цільовий кут, коли:
  - Двигун рухається (startStop.getState() == true)
  - Активний режим редагування через меню (MENU_SET_ANGLE)
  - Кут був встановлений вручну через меню (_manualAngleSet == true)

**Обнулення:**
- Натискання кнопки ENCODER_ZERO_BUTTON (пін 5):
  - Зберігає поточний цільовий кут
  - Встановлює поточну позицію двигуна як нульову
  - Встановлює поточний кут енкодера як 0°
  - Відновлює збережений цільовий кут
  - Зберігає всі налаштування в EEPROM

### 2.4. Поведінка кнопок

#### Кнопка енкодера (ENC_BTN, пін 4)

**Коротке натискання (< 2 секунди):**
- На сплеш-екрані: перехід в головне меню
- В головному меню: вхід у вибраний пункт
- В меню Set Angle: повернення на сплеш-екран
- В меню Settings: повернення на сплеш-екран
- В меню Save: збереження та повернення на сплеш-екран

**Довге натискання (≥ 2 секунди):**
- На сплеш-екрані: перемикання утримання двигуна (Hold ON ↔ Released)
- В будь-якому меню: повернення на сплеш-екран

**Debounce:** 50 мс (BUTTON_DEBOUNCE_MS)

#### Кнопка старт-стоп (START_STOP_BUTTON, пін 12 для Nano/Uno)

**Призначення:** Запуск/зупинка руху двигуна до цільового кута

**Поведінка:**
- Натискання → запуск руху до цільового кута
- Світлодіод (пін 11) світиться під час руху
- Двигун автоматично зупиняється при досягненні цільового кута (різниця < 2 кроків)

**Debounce:** 50 мс

#### Кнопка обнулення енкодера (ENCODER_ZERO_BUTTON, пін 5)

**Призначення:** Встановлення поточного положення як нуль (0°)

**Поведінка:**
- Працює на всіх екранах
- Натискання → обнулення енкодера та збереження в EEPROM
- Показує повідомлення "Encoder" на 400 мс

#### Кнопка перемикання розрядів (DIGIT_MODE_BUTTON, пін 8)

**Призначення:** Перемикання режиму редагування кута в меню Set Angle

**Поведінка:**
- Працює тільки в меню Set Angle
- Натискання → циклічне перемикання: Units → Tens → Hundreds → Units

#### Кнопка точного регулювання (STEP_FINE_ADJUST_BUTTON, пін A2)

**Призначення:** Рух двигуна на один крок вперед

**Поведінка:**
- Коротке натискання → один крок вперед
- Довге натискання (≥ 500 мс) → швидке повторення кроків (кожні 100 мс)
- Рух завжди вперед, незалежно від напрямку

### 2.5. Зміна значень та збереження

#### Встановлення цільового кута

**Спосіб 1: Через абсолютний енкодер (автоматично)**
- Обертання абсолютного енкодера → автоматичне встановлення як цільовий кут
- Відображається на сплеш-екрані в рядку "Target: XXX°"

**Спосіб 2: Через меню Set Angle (вручну)**
- Вхід в меню Set Angle
- Обертання інкрементального енкодера для зміни кута
- Перемикання режиму розряду кнопкою DIGIT_MODE_BUTTON
- Вихід з меню → кут зберігається як встановлений вручну

#### Збереження налаштувань

**Автоматичне збереження:**
- При обнуленні енкодера (ENCODER_ZERO_BUTTON) → автоматичне збереження в EEPROM

**Ручне збереження:**
- Вхід в меню "Save"
- Натискання кнопки енкодера → збереження:
  - Поточна позиція двигуна
  - Напрямок руху (CW/CCW)
  - Нульова позиція двигуна

**Що зберігається в EEPROM:**
- Позиція двигуна (int32_t, 0-3200 кроків)
- Напрямок руху (uint8_t, 0 = CW, 1 = CCW)
- Нульова позиція двигуна (int32_t, 0-3200 кроків)
- Контрольна сума (checksum) для перевірки цілісності

**Адреса EEPROM:** 0 (початок)

### 2.6. Вихід з меню

**Способи виходу:**
1. Коротке натискання кнопки енкодера → повернення на сплеш-екран
2. Довге натискання кнопки енкодера (≥2 секунди) → повернення на сплеш-екран

**Поведінка при виході:**
- Автоматичне оновлення сплеш-екрану
- Збереження встановлених значень (крім Save меню, де потрібне підтвердження)

---

## 3. ОБМЕЖЕННЯ ТА ПРАВИЛА

### 3.1. Діапазони значень

#### Кут (градуси)
- **Мінімальне значення:** 0°
- **Максимальне значення:** 359°
- **Обгортка:**
  - При перевищенні 359° → встановлюється 0°
  - При меншому за 0° → встановлюється 359°

#### Позиція двигуна (кроки)
- **Мінімальна позиція:** 0 кроків (0°)
- **Максимальна позиція:** 3200 кроків (360°)
- **Точність:** 1 крок = 360° / 3200 = 0.1125°

#### Конвертація кута в кроки
- Формула: `кроки = (кут × 3200) / 360`
- Приклад: 90° = (90 × 3200) / 360 = 800 кроків

### 3.2. Поведінка на границях

#### Обгортка кута
- При редагуванні кута в меню Set Angle:
  - Якщо newAngle > 359 → встановлюється 0
  - Якщо newAngle < 0 → встановлюється 359

#### Обгортка позиції
- Позиція двигуна нормалізується до діапазону 0-3200 кроків:
  - Якщо позиція < 0 → додається 3200 до досягнення діапазону
  - Якщо позиція ≥ 3200 → віднімається 3200 до досягнення діапазону

#### Обгортка меню
- В головному меню:
  - З останнього пункту (Save Position) → перехід на перший (Set Angle)
  - З першого пункту (Set Angle) → перехід на останній (Save Position)

### 3.3. EEPROM

#### Використання
- **Адреса:** 0 (початок EEPROM)
- **Структура даних:**
  - Позиція двигуна (4 байти, int32_t)
  - Напрямок руху (1 байт, uint8_t)
  - Нульова позиція двигуна (4 байти, int32_t)
  - Контрольна сума (1 байт, uint8_t)

#### Перевірка цілісності
- Використовується контрольна сума (XOR всіх полів)
- При невідповідності checksum → завантажуються значення за замовчуванням:
  - Позиція: 0
  - Напрямок: CW (0)
  - Нульова позиція: 0

#### Збереження
- Автоматично при обнуленні енкодера
- Вручну через меню "Save"

#### Завантаження
- Автоматично при включенні (в setup())
- Встановлюється позиція двигуна, напрямок та нульова позиція

### 3.4. Таймінги та затримки

| Параметр | Значення | Призначення |
|----------|----------|-------------|
| BUTTON_DEBOUNCE_MS | 50 мс | Затримка для усунення "дребезгу" кнопок |
| LONG_PRESS_THRESHOLD_MS | 2000 мс | Час для визначення довгого натискання кнопки енкодера |
| MENU_CHANGE_DELAY_MS | 150 мс | Затримка між змінами пунктів меню при обертанні енкодера |
| LCD_UPDATE_MS | 100 мс | Інтервал оновлення дисплея |
| SAVE_MESSAGE_MS | 400 мс | Час показу повідомлення про збереження |
| STEP_BUTTON_LONG_PRESS_MS | 500 мс | Час до початку швидкого повторення кроків |
| STEP_BUTTON_REPEAT_DELAY_MS | 100 мс | Затримка між кроками при довгому натисканні |

### 3.5. Особливості роботи

#### Утримання двигуна (ENABLE_PIN)
- **LOW (0):** Двигун утримується (струм проходить через обмотки)
- **HIGH (1):** Двигун знято з утримання (струм не проходить)
- **Управління:** Довге натискання кнопки енкодера на сплеш-екрані

#### Прискорення/заспілення двигуна
- **Початкова затримка:** 1500 мкс (STEP_DELAY_ACCEL_US)
- **Мінімальна затримка:** 400 мкс (максимальна швидкість)
- **Максимальна затримка:** 2000 мкс (мінімальна швидкість)
- **Початок заспілення:** за 160 кроків до цілі (~18°)

#### Точність зупинки
- Двигун зупиняється, коли різниця між поточним кутом енкодера та цільовим кутом < 2 градусів
- Використовується кут з абсолютного енкодера для точної зупинки

#### Фільтрація абсолютного енкодера
- Ковзне середнє з 8 зразків
- Експоненційне усереднення для відображення (70% старого + 30% нового)
- Поріг оновлення відображення: 0.1 градуса

### 3.6. Обмеження та правила

#### Обмеження навігації
- Затримка 150 мс між змінами пунктів меню (запобігає швидкому прокручуванню)
- Обмеження encoderDelta до ±1 для плавної навігації

#### Обмеження редагування кута
- Кут обмежений діапазоном 0-359 градусів
- Автоматична обгортка на границях

#### Обмеження руху двигуна
- Мінімальний поріг руху: 10 кроків (запобігає дрібним коливанням)
- Гістерезис для запобігання швидкому старту/зупинці

#### Обмеження EEPROM
- Дані зберігаються тільки при явному збереженні або обнуленні енкодера
- Перевірка цілісності через контрольну суму
- При помилці → завантаження значень за замовчуванням

---

## 4. ТЕХНІЧНІ ПАРАМЕТРИ

### 4.1. Механіка

- **Кроків на оберт:** 200 (STEPS_PER_REV)
- **Мікростеп:** 16 (MICROSTEP)
- **Кроків на 360°:** 3200 (STEPS_360)
- **Точність:** ~0.1125° на крок

### 4.2. Драйвер крокового двигуна (DM556D)

- **STEP_PIN:** Пін 6 (імпульси кроків)
- **DIR_PIN:** Пін 7 (напрямок руху)
- **ENABLE_PIN:** Пін 9 (утримання двигуна)
- **Тривалість імпульсу:** 4 мкс (STEP_PULSE_US)
- **Затримка між кроками:** 600 мкс (STEP_DELAY_US)

### 4.3. Дисплей

- **Тип:** LCD2004 (20 символів × 4 рядки)
- **Інтерфейс:** I2C
- **Адреса:** 0x27 (може бути 0x3F)
- **Оновлення:** кожні 100 мс

---

## 5. ДІАГНОСТИКА

### 5.1. Типові проблеми

**Проблема:** Меню не відкривається
- Перевірте підключення кнопки енкодера (пін 4)
- Перевірте, чи кнопка активна LOW (INPUT_PULLUP)

**Проблема:** Енкодер не працює
- Перевірте підключення ENC_A (пін 2) та ENC_B (пін 3)
- Перевірте, чи піни підключені до INT0 та INT1

**Проблема:** Двигун не рухається
- Перевірте підключення STEP_PIN (пін 6), DIR_PIN (пін 7), ENABLE_PIN (пін 9)
- Перевірте стан ENABLE_PIN (LOW = утримується, HIGH = знято)

**Проблема:** Абсолютний енкодер не працює
- Перевірте підключення до A0
- Перевірте живлення енкодера (5V)
- Перевірте опорну напругу (5V)

**Проблема:** Налаштування не зберігаються
- Перевірте, чи викликається меню "Save" та підтверджується збереження
- Перевірте контрольну суму в EEPROM

---

## 6. ПРИМІТКИ

- Всі кнопки використовують INPUT_PULLUP (активний LOW)
- Інкрементальний енкодер використовує переривання (INT0, INT1)
- Абсолютний енкодер використовує аналогове читання з фільтрацією
- LCD2004 використовує I2C інтерфейс (не використовується 4-bit режим)
- Напрямок руху керується програмно через меню Settings (не використовується апаратний перемикач)
